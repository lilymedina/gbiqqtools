#' Draw parameters
#' Default behavior takes a random draw of parameters from priors; can also draw from posteriors, or return pre-defined parameters.
#'
#' @param model A model object generated by \code{make_model()}.
#' @param using String indicating whether to use `priors`, `posteriors` or `parameters`
#' @importFrom gtools rdirichlet
#' @return A named list of parameters.
#' @export
#' @examples
#' draw_parameters(model = make_model("X->Y"))
#'
draw_parameters <- function(model, using = NULL){

	if(is.null(using)) using <- "priors"

	if(!(using %in% c("priors", "posteriors", "parameters"))) stop(
		"`using` should be one of `priors`, `posteriors`, or `parameters`")

	if(using == "parameters") {if(is.null(model$parameters)) stop("No parameters provided")
		                         return(model$parameters)}

	if(using == "posteriors") {if(is.null(model$posterior)) stop("No posterior provided")
		param_dist <- rstan::extract(model$posterior, pars= "lambdas")$lambdas
		return(param_dist[sample(nrow(param_dist),1),])
	}

	if(is.null(model$priors)) {model <- set_priors(model)
	message(paste("Priors missing from model. Generated on the fly."))
	}

	if(is.null(model$P)) {model <- set_parameter_matrix(model)
	message(paste("Parameter matrix missing from model. Generated on the fly."))
	}

	lambdas_prior <- model$priors
	param_set     <- attr(model$P, "param_set")

	if(length(lambdas_prior) != length(param_set)) stop("parameters priors should have same length as parameter set")

	param_sets         <- unique(param_set)

	# Draw parameters, given priors
	parameters <- unlist(sapply(param_sets, function(v){
		i <- which(startsWith(names(lambdas_prior), paste0(v,".")))
		gtools::rdirichlet(1, lambdas_prior[i])}))
	names(parameters) <- names(lambdas_prior)
	parameters
}

#' Draw type probabilities
#'
#' Draws probability of vector of causal types given a single realization of parameters, possibly drawn from model priors.
#'
#' @param model A model object generated by \code{make_model()}.
#' @param P A matrix. Parameter matrix. Not required but may be provided to avoid repeated computation for simulations.
#' @param parameters A numeric vector. Optionally specify parameters. By default, parameters is drawn from `using` argument (either from priors, posteriors, or from model$parameters)
#' @param using A string taking value "priors", "posteriors" or "parameters".
#' @export
#'

draw_type_prob <- function(model,
													 P = NULL,
													 parameters = NULL,
													 using = NULL ){

	if(!is.null(parameters) & !is.null(using)) if(using!="parameters")
		stop("Parameters provided but using is not set to parameters")
	if(!is.null(parameters)) using <- "parameters"
	if(is.null(using)) {using <- "priors"; message("using not provided, priors assumed")}
	if(is.null(parameters))  parameters <- draw_parameters(model, using = using)
	if(is.null(P)) 	    P      <- get_parameter_matrix(model)

	# Type probabilities
	P.lambdas     <- P*parameters +	1 - P
	apply(P.lambdas, 2, prod)

}

#' Draw matrix of type probabilities, before or after estimation
#'
#' @param model A model, normally containing a prior or a posterior distribution.
#' @param using A character string indicating whether to use "priors", "posteriors" or "parameters".
#' @param parameters A numeric vector. True parameters to be used instead of parameters attached to the model in case `using` specifies `parameters`.
#' @param n_draws An integer. If no prior distribution is provided, generate prior distribution with \code{n_draws} number of draws.
#' @return A matrix of type probabilities.
#' @export
#' @examples
#' model <- make_model("X -> Y")
#' draw_type_prob_multiple(model, using = "priors", n_draws = 3)
#' draw_type_prob_multiple(model, using = "parameters", n_draws = 3)

draw_type_prob_multiple <- function(model,
																		parameters = NULL,
																		n_draws = 4000,
																		using = "priors"){

	if(using == "parameters") {
		if(is.null(model$parameters) & is.null(parameters)) stop("please provide parameters")
		if(is.null(parameters)) parameters <- model$parameters
		return(draw_type_prob(model, parameters = parameters, using = using))
	  }

	if(using == "priors"){
		if(is.null(model$prior_distribution)) {
			message("Prior distribution added to model")
			model <- set_prior_distribution(model, n_draws = n_draws)
		}
		param_dist <- model$prior_distribution
		}

	if(using == "posteriors"){
		if(is.null(model$posterior_distribution)) {
			stop("Model does not contain a posterior distribution")}
		param_dist <- rstan::extract(model$posterior, pars= "lambdas")$lambdas
	}

	apply(param_dist, 1, function(j) draw_type_prob(model, parameters = j))
}



#' Draw event probabilities
#'
# `draw_event_prob` draws event probability vector `w`  given a single realization of parameters
#'
#' @param model A model object generated by \code{make_model()}.
#' @param P A matrix. Parameter matrix. Not required but may be provided to avoid repeated computation for simulations.
#' @param A A matrix. Ambiguity matrix. Not required but may be provided to avoid repeated computation for simulations.
#' @param parameters A numeric vector. Values of parameters may be specified. By default, parameters is drawn from priors.
#' @param type_prob A numeric vector. Type probabilities (usually not required).
#' @param using String indicating whether to use "priors", "posteriors" or "parameters".
#'
#' @export
#' @examples
#' model <- make_model("X -> Y")
#' draw_event_prob(model = model)
#' draw_event_prob(model = model, using = "parameters")
draw_event_prob <- function(model,
														P = NULL,
														A = NULL,
														parameters = NULL,
														type_prob = NULL,
														using = NULL){


	if(is.null(parameters)) {parameters <- draw_parameters(model, using = using)}

	# Ambiguity matrix
	if(is.null(A)) 	    A <- get_ambiguities_matrix(model)

	# Type probabilities
	if(is.null(type_prob)) {
	type_prob <- draw_type_prob(model = model, P = P, parameters = parameters, using = using)}

	# Event probabilities  ## FLAG this is a hack for cases with only one possible data type
	if(ncol(A)==1) {out <- matrix(1); rownames(out) <- colnames(A); return(out)}

	t(A) %*% type_prob

}


#' Draw compact data
#'
#  Draw \code{n} events given event probabilities.
#'
#' @param model A model object generated by \code{make_model()}.
#' @param n An integer. Number of observations.
#' @param w A numeric vector of event probabilities.
#' @param P Parameter matrix. (Optional). May be provided to avoid repeated computation for simulations.
#' @param A Ambiguity matrix. (Optional). May be provided to avoid repeated computation for simulations.
#' @param parameters A numeric vector. Values of parameters may be specified. By default, it is drawn from priors.
#' @param using String indicating whether to use "priors", "posteriors" or "parameters".
#' @return A data frame of events
#' @importFrom stats rmultinom
#' @export
#'
#' @examples
#' model <- make_model("X -> Y")
#' draw_data_events(model = model)

draw_data_events <- function(model, n = 1,
							w = NULL,
                      P = NULL,
											A = NULL,
											parameters = NULL,
											using = NULL
											){

 if(is.null(w)){
 	if(is.null(P)) 	P <- get_parameter_matrix(model)
 	if(is.null(A)) 	A <- get_ambiguities_matrix(model)
 	w <- draw_event_prob(model, P, A, parameters = parameters, using = using)
 }

	# Draw events (Compact dataframe)
	data.frame(event = rownames(w), count = rmultinom(1, n, w))

}

#' Generate full dataset, possibly from compact data
#'
#' @param model A model object generated by \code{make_model()}.
#' @param n An integer. Number of observations.
#' @param data_events A compact data frame compatible with \code{model}.
#' @param parameters A numeric vector. Values of parameters may be specified. By default, parameters is drawn from priors.
#' @param using String indicating whether to use "priors", "posteriors" or "parameters". Defaults to "parameters".
#' @return A data frame of simulated data.
#' @export
#' @examples
#' model <- make_model("X -> Y")
#' data_events <- draw_data_events(model = model, n = 4)
#' simulate_data(model, data_events = data_events)

simulate_data <- function(model,
													n = 1,
													data_events = NULL,
													parameters = NULL,
													using = "parameters"){

	if(!is.null(using)) if(using == "parameters" & is.null(parameters)) {
	if(is.null(model$parameters)) stop("parameters not provided")}

	# Data drawn here
	if(is.null(data_events)) data_events <- draw_data_events(model, n = n, parameters = parameters, using = using)

	# The rest is reshaping
	vars <- model$variables
	df <- merge(all_data_types(model), data_events, by.x = "event")
	xx  <- unlist(sapply(1:nrow(df), function(i) replicate(df[i,ncol(df)], df[i, vars])))
	out <- data.frame(matrix(xx, ncol = length(vars), byrow = TRUE))
	names(out) <- vars

	out
 }


#' Data type names
#'
#' Provides names to data types
#' @param model A model created by make_model()
#' @param data Data in long form
#' @export
#' @examples
#' model <- make_model("X -> Y")
#' data <- simulate_data(model, n = 2)
#' data_type_names(model, data)
#'
data_type_names <- function(model, data){
	vars <- model$variables
  data <- data[vars]
	data[data==""] <- NA
  out <- apply(data, 1, function(j) paste(paste0(vars[!is.na(j)], j[!is.na(j)]), collapse = ""))
  out[out == ""] <- "None"
  out}

#' All data types
#'
#' Creates dataframe with all data types, including NA types possible from a model
#'
#' @param model A model created by make_model()
#' @export
#' @examples
#' all_data_types(make_model("X -> Y"))

all_data_types <- function(model) {
	variables <- model$variables
	m <- length(model$variables)
	df <- data.frame(gbiqq::perm(rep(2, m))) - 1
	df[df==-1] <- NA
	names(df) <-  variables
  data.frame(cbind(event = data_type_names(model, df), df))
}



#' Make data compact with data as first argument
#'
#' @param data A datafram
#' @param model A model
#' @export
collapse_data <- function(data, model, remove_family = TRUE){
	x <- summarize_data(model = model, data)
	if(remove_family) x <- x[, -2]
	x
	}
